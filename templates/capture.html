<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- <script src="https://unpkg.com/webcam-easy@1.1.1/dist/webcam-easy.min.js"></script> -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="icon" type="image/svg" href="{{url_for('static', filename='favicon.svg')}}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="{{url_for('static', filename='clear.css')}}">
    <link rel="stylesheet" href="{{url_for('static', filename='capture.css')}}">
    <title>Document Scanner</title>
</head>
<body>
    <div class="container">
        <div class="exam-pic-camera">
            <div class="video-container">
                <video id="webCam" ondrop="loadImageForm(event)" muted autoplay playsinline></video>
            </div>
            <div class="float-canva canva-container">
                <canvas id="canvas"></canvas>
            </div>
            <div class="float-canva final-output">
                <canvas id="canvas-to-send"></canvas>
            </div>
            <button id="snap" onclick="snap(); return true;" class="cam-opt" download><i class="fa fa-camera"></i></button>
            <button id="send" onclick="send(); return true;" class="cam-opt" download><i class="fa fa-paper-plane"></i></button>
            <button id="retry" onclick="retry();" class="cam-opt" download><i class="fa fa-eraser"></i></button>
            <!-- <button id="flip" onclick="webcam.flip();webcam.start();return true;" class="cam-opt"><i class="fa fa-rotate-right"></i></button> -->
            <!-- <button id="menu" onclick="sendToIbrep()" class="cam-opt"><div class="ibrep-icon"></div></button> -->
        </div>
    </div>
    <script>
        const webCamElement = document.getElementById("webCam");
        const canvasElement = document.getElementById("canvas");
        const canvasToSend = document.getElementById("canvas-to-send");

        var webCamStream;
        var gabaritoData;
        var errors;
        var questionCount;
        var choicesCount;
        var id_solicitacao_prova;

        var imgBuffer;

        navigator.mediaDevices
            .getUserMedia({ video: {facingMode: "environment" }, audio: false })
            .then((stream) => {
                webCamElement.srcObject = stream;
                webCamElement.play();
                webCamStream = stream;
            })
            .catch((err) => {
                console.error(`An error occurred: ${err}`);
            });

        webCamElement.addEventListener("dragenter", (event) => {
            event.preventDefault();
        });

        webCamElement.addEventListener("dragover", (event) => {
            event.preventDefault();
        });

        async function loadImageForm(e) {
            e.preventDefault();
            snap();

            let file = e.dataTransfer.files[0];
            let fileReader = new FileReader();
            let img = new Image();

            img.onload = () => {
                canvasToSend.height = img.height;
                canvasToSend.width = img.width;
                canvasToSend.getContext("2d").drawImage(img, 0, 0);
                webCamElement.parentElement.style.zIndex = "-1";
    
                imgBuffer = canvasToSend.toDataURL();
            }

            img.src = URL.createObjectURL(file);
        }

        function snap() {

            const streamSettings = webCamStream.getVideoTracks()[0].getSettings();


            canvasToSend.height = streamSettings.height;
            canvasToSend.width = streamSettings.width;
            canvasToSend.getContext("2d").drawImage(webCamElement, 0, 0);
            webCamElement.parentElement.style.zIndex = "-1";

            imgBuffer = canvasToSend.toDataURL();
        }

        function retry() {
            canvasToSend.height = 1;
            canvasToSend.width = 1;
            webCamElement.parentElement.style.position = "relative";
            webCamElement.parentElement.style.zIndex = "0";
        }

        function send() {
            const url = "/api/exam/review"
            body = {
                "choicesCount": Number(choicesCount),
                "questionCount": Number(questionCount),
                "examPhotoType": 0,
                "examPhoto": imgBuffer
            }

            document.body.classList.add("loading")

            fetch(url, {
                method: 'POST',
                headers: {
                    'Accept': 'application/json',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(body)
            })
                .then(res => res.json())
                .then(data => {
                    if (!dataHasErr(data)) {
                        gabaritoData = data
                        Swal.fire({
                            text: "Dados de gabarito e QR salvos",
                            icon: "success"
                        });
                        sendToIbrep();
                        return;
                    } else {
                        handleApiError(data)
                    }
                })
                .catch(err => console.log(err))
                .finally(() => {
                    document.body.classList.remove("loading")
                })
        }

        function askIdMatricula() {
            return Swal.fire({
                title: "Digite a matricula",
                input: "tel",
                inputLabel: "Digite o Idmatricula do aluno em específico",
                inputPlaceholder: "ex.: 654321",
                inputAttributes: {
                    maxlength: "10",
                    autocapitalize: "off",
                    autocorrect: "off"
                }
                // preConfirm: () => {
                //     return document.getElementById("idmatricula").value;
                // }
            })
                .then(data => data.value)
        }

        function dataHasErr(data) {
            if (!("err" in data)) return false
            if (!(data["err"])) return false
            if (Object.entries(data["err"]).length === 0) return false
            return true
        }

        function makeTextExamButtons(test) {
            return `<button 
                onclick='id_solicitacao_prova=${test["id_solicitacao_prova"]}'>
                De ${test['de']} até ${test['ate']}
            </button>`;
        }

        function handleIbrepApiFollowUp(followUpData) {
            html = "<h1>Selecione a prova desejada</h1>";

            followUpData['follow_up'].forEach(test => {
                html += makeTextExamButtons(test);
            });

            Swal.fire({
                html: html,
                icon: 'info'
            })
                .then((result) => {
                    sendToIbrep()
                        .then(() => {
                            id_solicitacao_prova = undefined;
                        });
                });
        }

        function handleIbrepApiAnswer(answer) {
            Swal.fire({
                html: `<div>Aluno: ${answer["aluno"][0]["aluno"]}</div><div>\nNota: ${answer['nota']}</div>`,
                icon: 'success'
            });
            gabaritoData = {}
        }

        function handleApiError(data) {
            errors = data["err"];

            errStr = Object.entries(errors).reduce((acc, cur) => acc + `\n${cur[0]}: ${cur[1]}`, '').slice(1);
            Swal.fire({
                text: errStr,
                icon: "error"
            });
        }

        async function sendToIbrep() {
            const url = "{{conf['ibrep_url']}}/api/set/score";

            while (true) {
                idmatricula = await askIdMatricula()
                if (idmatricula) {
                    break;
                }
                await Swal.fire({
                    text: "Necessito da matricula do aluno em questão.",
                    icon: "error"
                });
            }

            iddisciplina = gabaritoData["iddisciplina"]
            nota = gabaritoData["score"]
            idtipo = gabaritoData["idtipo"]
            idmodelo = gabaritoData["idmodelo"]
            marked = gabaritoData["marked"]
            protocolo = "prova final"

            body = {
                idmatricula,
                iddisciplina,
                nota,
                idtipo,
                idmodelo,
                protocolo,
                marked,
                id_solicitacao_prova
            }

            document.body.classList.add("loading")

            fetch(url, {
                method: 'POST',
                body: JSON.stringify(body)
            })
            .then(res => res.json())
            .then(data => {
                if ('follow_up' in data) {
                    handleApiError({"err": {"1": "Existem mais de 1 prova para esse aluno hoje. Por favor, contacte o IBREP para mais informações."}})
                    return;
                    handleIbrepApiFollowUp(data);
                } else if (!dataHasErr(data)) {
                    handleIbrepApiAnswer(data);
                } else {
                    handleApiError(data);
                }
            })
            // .catch(err => Swal.fire({
            //     text: err,
            //     icon: 'error'
            // }))
            .finally(() => {
                document.body.classList.remove("loading")
            })
        }
    </script>
</body>
</html>