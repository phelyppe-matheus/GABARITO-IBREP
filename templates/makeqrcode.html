<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="{{url_for('static', filename='swiped-events.js')}}"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js" integrity="sha512-CNgIRecGo7nphbeZ04Sc13ka07paqdeTu0WR1IM4kNcpmBAUSHSQX0FslNhTDadL4O5SAGapGt4FodqL8My0mA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <title>Faça aqui o seu qrcode</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Work+Sans:wght@100..900&display=swap');

        * {
            font-family: 'Work Sans', sans-serif;
            margin: 0;
            padding: 0;
            border: none;
            text-decoration: none;

            box-sizing: border-box;
        }

        body {
            display: flex;
            flex-direction: row-reverse;
        }

        ol {
            list-style-position: inside;
        }

        p, h1, h2, h3, h4, li, a, span {
            text-wrap: pretty;
        }

        .dashboard {
            --background: #efefef;

            position: relative;
            grid-template-rows: 1fr repeat(2, min-content) 1fr;
            width: 60vw;
            left: auto;
            padding: 0 2rem;

            place-content: center;

            top: 0;
            min-height: 100vh;
            min-height: 100dvh;

            background: var(--background);

            display: grid;
            grid-template-columns: 1fr 2rem auto;
            align-items: end;
            gap: 1rem;

            /* box-shadow: -100vw 0 0 0 black inset; */

            animation: swipe-right 500ms ease-in-out;
        }

        /* Chrome, Safari, Edge, Opera */
        .dashboard input::-webkit-outer-spin-button,
        .dashboard input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        /* Firefox */
        .dashboard input[type=number] {
            -moz-appearance: textfield;
        }

        .dashboard.closed {
            animation: swipe-left 500ms ease-in-out forwards;
        }

        @keyframes swipe-right {
            0% {
                right: 100%;
                box-shadow:
                    -100vw 0 0 0 black inset;
            }
            60% {
                right: 10%;
                box-shadow:
                    -100vw 0 0 0 rgb(144, 2, 157) inset,
                    -100vw 0 0 0 rgb(5, 142, 241) inset;
            }
            70% {
                right: 10%;
                box-shadow:
                    -0vw 0 0 0 rgb(144, 2, 157) inset,
                    -100vw 0 0 0 rgb(5, 142, 241) inset;
            }
            100% {
                right: auto;
                box-shadow:
                    -0vw 0 0 0 rgb(144, 2, 157) inset,
                    -0vw 0 0 0 rgb(5, 142, 241) inset;
            }
        }

        @keyframes swipe-left {
            100% {
                right: 100%;
                box-shadow:
                    -100vw 0 0 0 black inset;
            }
            40% {
                right: 10%;
                box-shadow:
                    -100vw 0 0 0 rgb(144, 2, 157) inset,
                    -100vw 0 0 0 rgb(5, 142, 241) inset;
            }
            30% {
                right: 10%;
                box-shadow:
                    -0vw 0 0 0 rgb(144, 2, 157) inset,
                    -100vw 0 0 0 rgb(5, 142, 241) inset;
            }
            0% {
                right: auto;
                box-shadow:
                    -0vw 0 0 0 rgb(144, 2, 157) inset,
                    -0vw 0 0 0 rgb(5, 142, 241) inset;
            }
        }

        .dashboard h1 {
            grid-area: 1/1/2/3;
        }

        .dashboard label {
            font-size: 0.8rem;
        }

        .dashboard label::after {
            content: ":";
        }

        .dashboard input {
            text-align: right;
            padding: 0.2rem 0.5rem;

            background: transparent;
            border: none;
            border-bottom: 1px solid black;
        }

        .dashboard .gabarito {
            --choice-size: 0.8rem;
            --gap: 1rem;
            position: relative;
            justify-self: center;
            align-self: center;
            grid-area: 1/3/6/4;
        }

        .dashboard .gabarito:has(.columnlabel) {
            margin-left: 1rem;
        }

        .dashboard .gabarito .column {
            padding: calc(var(--gap) / 2);
            display: flex;
            flex-direction: column;
            gap: var(--gap);
            border: 1px solid black;
        }

        .dashboard .gabarito .row {
            display: flex;
            flex-direction: row;
            gap: var(--gap);
        }

        .dashboard .gabarito .choice {
            aspect-ratio: 1;

            border: 1px solid;
            width: var(--choice-size);
            border-radius: 50%;
        }

        .dashboard .gabarito h1 {
            position: absolute;
            inset: 50% 100% 50% 0%;
            height: fit-content;
            width: fit-content;
            transform: translate(-50%) rotate(-90deg) translateY(-100%);
            /* font-size: 6rem; */
            line-height: 1rem;
        }

        .qrcode {
            display: grid;
            place-content: center;
            place-items: center;

            padding: 1rem;
        }

        .test {
            --gap: 1rem;
            display: grid;
            height: 100vh;
            padding: 2rem;
            grid-template-columns: 1fr 1fr auto;
            grid-template-rows: repeat(3, min-content) 1fr;
            gap: var(--gap);
            place-items: center;
            place-content: center;

            font-family: Verdana, Geneva, Tahoma, sans-serif;
            isolation: isolate;
            visibility: visible;
        }

        .test .test-title {
            display: grid;
            grid-template-columns: subgrid;
            align-items: center;

            grid-area: 1/1/2/4;
        }

        .test .test-title img {
            width: 100%;
            grid-area: 1/1/2/2;
        }
        
        .test .test-title .title-left {
            text-align: right;
            grid-area: 1/2/2/4;
        }

        .test .test-title h1 {
            font-size: 1.3rem;
        }

        .test .test-title span {
            display: block;
        }

        .test .test-header {
            display: grid;
            grid-template-columns: repeat(10, 1fr);
            flex-wrap: wrap;
            grid-area: 2/1/3/3;
            width: 100%;
            place-content: center;
            gap: var(--gap);
            font-size: 1rem;
        }

        .test .test-header .name {
            grid-column: 1/7;
        }

        .test .test-header .cpf {
            grid-column: 7/11;
        }

        .test .test-header .professor {
            grid-column: 1/6;
        }

        .test .test-header .fu {
            grid-column: 6/8;
        }

        .test .test-header .date {
            grid-column: 8/11;
        }

        .test .test-header>* {
            position: relative;
        }
        .test .test-header>*::after {
            content: ":";
            border-bottom: 1px black solid;
            position: absolute;
            width: fill-available;
            width: -webkit-fill-available;
        }

        .test .qrcode {
            grid-area: 2/3/3/4;
            height: 10rem;
            visibility: visible;
            isolation: isolate;
            display: block;
        }

        .test .qrcode img {
            height: inherit;
        }

        .test .test-info {
            grid-area: 3/1/4/4;
        }

        .test .test-info .title-center {
            text-align: center;
        }

        .test .test-info .outro {
            text-align: right;
        }

        .test .test-body {
            grid-area: 4/1/5/4;
            height: 100%;
        }
        .test .test-body .gabarito {
            --choices: 5;
            --questions: 20;
            display: none;
            grid-template-columns: repeat(var(--choices), 1fr);

            position: relative;

            box-shadow: 0 0 0 2px black inset;
        }

        .test .test-body .gabarito>* {
            width: 2mm;
            margin: 2mm;
            aspect-ratio: 1;

            box-sizing: content-box;
            border-radius: 50%;
            border: 1px black solid;
        }

        .gabarito .rowlabel,
        .gabarito .columnlabel {
            justify-content: space-around;
            position: absolute;
            aspect-ratio: auto !important;
            border: none !important;
            margin: 0;
            text-align: end;
        }

        .gabarito .rowlabel {
            display: flex;
            flex-direction: row;
            width: 100% !important;
            bottom: 100%;
            padding: 0.3rem 0;
        }
        .gabarito .columnlabel {
            display: flex;
            flex-direction: column;
            height: 100%;
            right: 100%;
            padding: 0 0.3rem;
            width: auto;
        }

        @media (max-width: 1000.0000000000001px) {
            body {
                display: block;
            }
            .dashboard {
                position: absolute;
                width: 90%;
                padding: 2rem;
                grid-template-rows: repeat(4, min-content);
            }

            .dashboard .gabarito {
                grid-area: auto/1/auto/3;
            }

            .dashboard h1 {
                grid-area: 1/1/2/3;
            }

            .test {
                visibility: hidden;
            }
        }

        @media print {
            body>* {
                visibility: hidden;
            }

            body .test {
                visibility: visible;
                padding: 0;
            }

            body .test .test-body .gabarito {
                display: grid;
                position: relative;
            }
        }

        button.control {
            position: absolute;
            inset: auto 10px 10px auto;
            background-color: aliceblue;

            width: 3rem;
            aspect-ratio: 1;

            border-radius: 50%;
        }

        button.control:hover {
            background-color: aquamarine;
        }

    </style>
</head>
<body>
    <div class="test">

        <div class="test-title">
            <img src="https://corretorcursoadistancia.com.br/wp-content/uploads/2023/08/logotipo_ibrep-prreto-55-min-1.png" alt="logo ibrep">
            <h1 class="title-left"><span>Curso</span>Técnico em transações imobiliárias</h1>
        </div>
        <div class="test-header">
            <div class="studentdata name">Aluno</div>
            <div class="studentdata cpf">Cpf</div>
            <div class="studentdata professor">Professor(a)</div>
            <div class="studentdata fu">UF</div>
            <div class="studentdata date">Data</div>
        </div>
        <div id="qrcode" src="" alt="qrcode da prova" class="qrcode"></div>
        <div class="test-info">
            <h2 class="title-center">Informações Importantes</h2>
            <ol>
                <li class="rules">Durante a realização da avaliação não é permitido a utilização de fones de ouvido e
                    aparelhos eletrônicos(celulares, tablets, computadores e etc.);</li>
                <li class="rules">A avaliação é individual e sem consulta;</li>
                <li class="rules">Não é permitido a reprodução das Informações contidas na avaliação, seja por
                    transcrição, ou registro fotográfico;</li>
                <li class="rules">São válidos apenas as respostas preenchidas no gabarito;</li>
                <li class="rules">Utilize caneta estereografica azul ou preta;</li>
                <li class="rules">Fique atento(a) ao preenchimento do gabarito. Marque as respostas no campo
                    correspondente a cada item. Em caso de rasura a questão será anulada;</li>
            </ol>
            <h3 class="outro">Boa prova</h3>
        </div>
        <div class="test-body">
            <div class="gabarito" id="test-gabarito">
            </div>
        </div>
    </div>
    <div id="dashboard" class="dashboard">
        <h1>Menu ibrep</h1>
        <label for="iddisciplina" style="display: none;">Disciplina (ID)</label>
        <input type="hidden" id="iddisciplina" name="iddisciplina" value="385">
        <label for="idtipo" style="display: none;">Tipo de nota (ID)</label>
        <input type="hidden" id="idtipo" name="idtipo" value="1">
        <label for="idmodelo"  style="display: none;">Modelo de prova (ID)</label>
        <input type="hidden" id="idmodelo" name="idmodelo" value="0">
        <label for="choices">Número de escolhas</label>
        <input type="number" id="choices" name="choices" value="5">
        <label for="questons">Número de questões</label>
        <input type="number" id="questions" name="questions" value="20">
        <div id="gabarito" class="gabarito">
            <h1>Gabarito</h1>
        </div>
    </div>
    <div id="info" class="info">
    </div>
    <button class="control print" onclick="print()"><i class="fa fa-print"></i></button>
    <script>
        function removeAllChildren(el) {
            while (el.firstChild) {
                el.removeChild(el.lastChild);
            }
        }

        function loadCells() {
            choices = document.getElementById("choices");
            questions = document.getElementById("questions");

            allChoices = document.createElement("div")
            columnlabel = document.createElement("div")
            columnlabel.classList.add("columnlabel")
            column = document.createElement("div")
            column.classList.add("column")
            rowlabel = document.createElement("div")
            rowlabel.classList.add("rowlabel")
            row = document.createElement("div")
            row.classList.add("row")
            cell = document.createElement("input")
            cell.type = "radio"
            cell.classList.add("choice")

            for (let i = 0; i < choices.value; i++) {
                row.appendChild(cell.cloneNode())
                const p = document.createElement('p');
                p.innerText = String.fromCharCode(97+i)
                rowlabel.appendChild(p);
            }
            for (let i = 0; i < questions.value; i++) {
                column.appendChild(row.cloneNode(true))
                Array.from(row.cloneNode(true).children).map(el => allChoices.appendChild(document.createElement("div")))
                const p = document.createElement('p');
                p.innerText = i
                columnlabel.appendChild(p);
            }

            Array.from(column.children).map((row, i) => Array.from(row.children).map((cell, j) => {
                cell.name=`choice${i}`;
                cell.value = j;
                cell.addEventListener("change", () => {
                    loadQrcode();
                    loadInfo();
                });
            } ))

            removeAllChildren(document.getElementById("gabarito"))
            document.getElementById("gabarito").appendChild(rowlabel.cloneNode(true))
            document.getElementById("gabarito").appendChild(columnlabel.cloneNode(true))
            document.getElementById("gabarito").appendChild(column)

            removeAllChildren(document.getElementById("test-gabarito"))
            document.getElementById("test-gabarito").appendChild(rowlabel.cloneNode(true))
            document.getElementById("test-gabarito").appendChild(columnlabel.cloneNode(true))
            Array.from(allChoices.children).map(el => document.getElementById("test-gabarito").appendChild(el))

            return true;
        }

        function loadQrcode() {
            const url = "/encrypt"

            c = Number(document.getElementById("choices").value);
            q = Number(document.getElementById("questions").value);
            d = Number(document.getElementById("iddisciplina").value)
            t = Number(document.getElementById("idtipo").value)
            m = Number(document.getElementById("idmodelo").value)

            qrcode = document.getElementById("qrcode")

            if (!choices, !questions) return
            chosen = Array.from(document.querySelectorAll(".row > input[type='radio']:checked")).map(el => Number(el.value))
            if (chosen.length < q) return
            body = {
                "msg": chosen.join("")
            }

            fetch(url, {
                method: 'POST',
                headers: {
                    'Accept': 'application/json',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(body)
            })
                .then(res => res.text())
                .then(text => JSON.parse(text))
                .then(data => {
                    r = data['msg'] // respostas
                    removeAllChildren(qrcode);
                    new QRCode(qrcode, JSON.stringify({
                        r,
                        c,
                        q,
                        d,
                        t,
                        m,
                    })); // todos compactados para melhorar performance do qrcode
                    console.log("tried to put qr into", qrcode);
                })
                .catch(err => console.log(err))
                .finally(() => {
                    document.querySelector("#qrcode > img").download = true;
                });
            return true;
        }

        function setElementValue(el, value) {
            newEl = el.cloneNode();
            newEl.innerHtml = value;
            return newEl;
        }

        function loadInfo() {
            info = document.getElementById("info");

            label = document.createElement("h3")
            label.classList.add("label")
            info = document.createElement("p")
            info.classList.add("info")

            chosen = Array.from(document.querySelectorAll(".row > input[type='radio']:checked")).map(el => Number(el.value))
            choices = Number(document.getElementById("choices").value);
            questions = Number(document.getElementById("questions").value);
            iddisciplina = Number(document.getElementById("iddisciplina").value)
            idtipo = Number(document.getElementById("idtipo").value)
            idmodelo = Number(document.getElementById("idmodelo").value)

            removeAllChildren(info)
            info.appendChild(setElementValue(label, "Respostas Corretas"))
            info.appendChild(setElementValue(info, chosen))
            info.appendChild(setElementValue(label, "Qtd alternativas"))
            info.appendChild(setElementValue(info, choices))
            info.appendChild(setElementValue(label, "Qtd perguntas"))
            info.appendChild(setElementValue(info, questions))
            label.classList.add("fixed")
            info.classList.add("fixed")
            info.appendChild(setElementValue(label, "Disciplina (ID)"))
            info.appendChild(setElementValue(info, choices))
            info.appendChild(setElementValue(label, "Tipo (ID)"))
            info.appendChild(setElementValue(info, choices))
            info.appendChild(setElementValue(label, "Modelo (ID)"))
            info.appendChild(setElementValue(info, choices))
        }

        loadCells()

        document.addEventListener('swiped-left', function (e) {
            document.getElementById("dashboard").classList.add("closed");
        });
        document.addEventListener('swiped-right', function (e) {
            document.getElementById("dashboard").classList.remove("closed");
        });
        Array.from(document.querySelectorAll("input")).map(el => el.addEventListener("change", () => {
            loadQrcode();
            loadInfo();
        }));
        Array.from(document.querySelectorAll("#choices, #questions")).map(el => el.addEventListener("change", loadCells))
        Array.from(document.querySelectorAll("#choices, #questions")).map(el => el.addEventListener("click", loadCells))
    </script>
</body>
</html>